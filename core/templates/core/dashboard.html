{% extends "core/base.html" %}
{% load humanize %}
{% block content %}

  <!-- HEADER -->
  <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; justify-content:space-between;">
    <div>
      <h2 style="margin:0;">Dashboard</h2>
      <p class="muted" style="margin-top:6px; margin-bottom:0;">
        Viendo:
        {% for num, nombre in meses %}
          {% if num == mes %}{{ nombre }}{% endif %}
        {% endfor %}
        {{ anio }}
      </p>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn" href="{% url 'core:movimiento_nuevo' %}">+ Nuevo movimiento</a>
      <a class="btn btn2" href="{% url 'core:movimientos' %}">Ver movimientos</a>
      <a class="btn btn2" href="{% url 'core:categorias' %}">Categor√≠as</a>
    </div>
  </div>

  <!-- CHAT IA (SOLO EN DASHBOARD) -->
  <div class="card" style="margin-top:12px;">
    <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
      <div>
        <h3 style="margin:0;">ü§ñ Asistente</h3>
        <p class="muted" style="margin:6px 0 0;">Pregunta lo que quieras (ej: ‚Äú¬øC√≥mo voy este mes?‚Äù o ‚Äú¬øEn qu√© podr√≠a ahorrar?‚Äù)</p>
      </div>
      <button class="btn btn2" type="button" id="btnClearChat">Limpiar</button>
    </div>

    <div id="chatBox" class="chat-box" aria-live="polite"></div>

    <form id="chatForm" class="chat-form" autocomplete="off">
      {% csrf_token %}
      <input
        id="chatInput"
        name="mensaje"
        placeholder="Escribe tu pregunta‚Ä¶"
        required
      />
      <button class="btn" type="submit" id="chatSend">Enviar</button>
    </form>

    <div class="muted" id="chatStatus" style="margin-top:10px;"></div>

    <style>
      .chat-box{
        margin-top: 14px;
        height: 320px;
        overflow-y: auto;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: rgba(0,0,0,.12);
        padding: 12px;
      }
      .msg{
        display:flex;
        gap:10px;
        margin: 10px 0;
        align-items:flex-start;
      }
      .bubble{
        max-width: 860px;
        padding: 10px 12px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: rgba(255,255,255,.06);
        line-height: 1.35;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .me .bubble{
        border-color: rgba(96,165,250,.35);
        background: rgba(96,165,250,.10);
      }
      .ai .bubble{
        border-color: rgba(34,197,94,.25);
        background: rgba(34,197,94,.08);
      }
      .tag{
        font-weight: 900;
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: rgba(255,255,255,.05);
        color: rgba(226,232,240,.95);
        white-space: nowrap;
      }
      .me .tag{ border-color: rgba(96,165,250,.35); }
      .ai .tag{ border-color: rgba(34,197,94,.25); }

      .chat-form{
        margin-top: 12px;
        display:flex;
        gap: 10px;
        align-items:center;
      }
      .chat-form input{
        flex: 1 1 auto;
      }

      @media (max-width: 720px){
        .chat-box{ height: 360px; }
        .chat-form{ flex-direction: column; align-items: stretch; }
        .chat-form button{ width: 100%; }
      }
    </style>

    <script>
      (function(){
        const chatBox = document.getElementById("chatBox");
        const chatForm = document.getElementById("chatForm");
        const chatInput = document.getElementById("chatInput");
        const chatSend = document.getElementById("chatSend");
        const chatStatus = document.getElementById("chatStatus");
        const btnClear = document.getElementById("btnClearChat");

        const storageKey = "fjyn_chat_history_v1";

        function escapeHtml(text){
          return (text ?? "").replace(/[&<>"']/g, (m) => ({
            "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
          }[m]));
        }

        function addMsg(role, text){
          const wrap = document.createElement("div");
          wrap.className = "msg " + role;

          const tag = document.createElement("div");
          tag.className = "tag";
          tag.textContent = role === "me" ? "T√∫" : "Asistente";

          const bubble = document.createElement("div");
          bubble.className = "bubble";
          bubble.innerHTML = escapeHtml(text);

          wrap.appendChild(tag);
          wrap.appendChild(bubble);
          chatBox.appendChild(wrap);

          chatBox.scrollTop = chatBox.scrollHeight;
        }

        function loadHistory(){
          try{
            const raw = localStorage.getItem(storageKey);
            if(!raw) return;
            const arr = JSON.parse(raw);
            if(!Array.isArray(arr)) return;
            arr.forEach(m => addMsg(m.role, m.text));
          }catch(e){}
        }

        function saveToHistory(role, text){
          try{
            const raw = localStorage.getItem(storageKey);
            const arr = raw ? JSON.parse(raw) : [];
            arr.push({role, text, t: Date.now()});
            localStorage.setItem(storageKey, JSON.stringify(arr.slice(-50)));
          }catch(e){}
        }

        function clearHistory(){
          localStorage.removeItem(storageKey);
          chatBox.innerHTML = "";
          addMsg("ai", "Hola üëã Soy tu asistente. Preg√∫ntame por tu mes, tus gastos o ideas para ahorrar.");
        }

        btnClear.addEventListener("click", clearHistory);

        // mensaje inicial si no hay historial
        loadHistory();
        if(chatBox.children.length === 0){
          addMsg("ai", "Hola üëã Soy tu asistente. Preg√∫ntame por tu mes, tus gastos o ideas para ahorrar.");
        }

        chatForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const msg = chatInput.value.trim();
          if(!msg) return;

          chatInput.value = "";
          chatInput.focus();

          addMsg("me", msg);
          saveToHistory("me", msg);

          chatStatus.textContent = "Pensando‚Ä¶";
          chatSend.disabled = true;

          try{
            const res = await fetch("{% url 'core:asistente_preguntar' %}", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": (document.querySelector('input[name="csrfmiddlewaretoken"]') || {}).value || ""
              },
              body: JSON.stringify({ mensaje: msg })
            });

            const data = await res.json();
            if(!res.ok || !data.ok){
              const err = data && (data.error || data.detail) ? (data.error || data.detail) : "Error desconocido";
              addMsg("ai", "‚ö†Ô∏è " + err);
              saveToHistory("ai", "‚ö†Ô∏è " + err);
            }else{
              addMsg("ai", data.respuesta || "(sin respuesta)");
              saveToHistory("ai", data.respuesta || "(sin respuesta)");
            }
          }catch(err){
            addMsg("ai", "‚ö†Ô∏è Error de red. Intenta nuevamente.");
            saveToHistory("ai", "‚ö†Ô∏è Error de red. Intenta nuevamente.");
          }finally{
            chatStatus.textContent = "";
            chatSend.disabled = false;
          }
        });
      })();
    </script>
  </div>

  <!-- CARDS RESUMEN -->
  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <div class="muted">üí∞ Ingresos (mes)</div>
      <div style="font-size:26px;" class="money">$ {{ total_ingresos|floatformat:0|intcomma }}</div>
      <div class="muted" style="margin-top:6px;">
        vs mes anterior:
        {% if ingresos_var_pct is None %}
          ‚Äî
        {% else %}
          {% if ingresos_var_pct >= 0 %}‚Üë{% else %}‚Üì{% endif %}
          {{ ingresos_var_pct|floatformat:1 }}%
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="muted">üßæ Gastos (mes)</div>
      <div style="font-size:26px;" class="money">$ {{ total_gastos|floatformat:0|intcomma }}</div>
      <div class="muted" style="margin-top:6px;">
        vs mes anterior:
        {% if gastos_var_pct is None %}
          ‚Äî
        {% else %}
          {% if gastos_var_pct >= 0 %}‚Üë{% else %}‚Üì{% endif %}
          {{ gastos_var_pct|floatformat:1 }}%
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="muted">üìä Balance (mes)</div>
      <div style="font-size:26px;"
           class="money {% if balance >= 0 %}money-pos{% else %}money-neg{% endif %}">
        $ {{ balance|floatformat:0|intcomma }}
      </div>
      <div class="muted" style="margin-top:6px;">
        Tasa de ahorro:
        {% if tasa_ahorro is None %}
          ‚Äî
        {% else %}
          {{ tasa_ahorro|floatformat:1 }}%
        {% endif %}
      </div>
    </div>
  </div>

  <!-- TABLAS -->
  <div class="grid" style="grid-template-columns: 2fr 1fr; margin-top:12px;">

    <!-- Movimientos del mes -->
    <div class="card">
      <h3 style="margin-top:0;">Movimientos del mes</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Categor√≠a</th>
              <th class="td-right">Monto</th>
            </tr>
          </thead>
          <tbody>
            {% for m in ultimos %}
              <tr>
                <td>{{ m.fecha }}</td>
                <td>
                  {% if m.tipo == "INGRESO" %}
                    <span class="badge badge-ingreso">‚¨Ü Ingreso</span>
                  {% else %}
                    <span class="badge badge-gasto">‚¨á Gasto</span>
                  {% endif %}
                </td>
                <td>{{ m.categoria.nombre }}</td>
                <td class="money td-right">$ {{ m.monto|floatformat:0|intcomma }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="muted">No hay movimientos en este mes.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Top + Por categor√≠a -->
    <div class="card">
      <h3 style="margin-top:0;">Top 5 gastos del mes</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Categor√≠a</th>
              <th class="td-right">Monto</th>
            </tr>
          </thead>
          <tbody>
            {% for g in top_gastos %}
              <tr>
                <td>{{ g.categoria.nombre }}</td>
                <td class="money td-right">$ {{ g.monto|floatformat:0|intcomma }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="2" class="muted">Sin gastos este mes.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <h3 style="margin-top:14px;">Gastos por categor√≠a</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Categor√≠a</th>
              <th class="td-right">Total</th>
            </tr>
          </thead>
          <tbody>
            {% for c in gastos_por_categoria %}
              <tr>
                <td>{{ c.categoria__nombre }}</td>
                <td class="money td-right">$ {{ c.total|floatformat:0|intcomma }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="2" class="muted">Sin gastos este mes.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <style>
    @media (max-width: 980px){
      .grid[style*="grid-template-columns: 2fr 1fr"]{
        grid-template-columns: 1fr !important;
      }
    }
  </style>

{% endblock %}
